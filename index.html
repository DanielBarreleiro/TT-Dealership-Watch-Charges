<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30-Day Data Trend</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the chart and the regression plugin for the trendline -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-analytics@1.1.1/dist/chartjs-chart-analytics.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Data Trend: Last 30 Days</h1>
            <p class="text-gray-600 mt-2">Visualizing the latest data with a calculated trendline.</p>
        </header>

        <main>
            <div id="chart-container" class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                <canvas id="dataChart"></canvas>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-16">
                <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-gray-600 font-medium">Fetching latest data...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center bg-red-50 p-8 rounded-2xl shadow-md">
                 <h3 class="text-xl font-semibold text-red-800">Something Went Wrong</h3>
                 <p class="text-red-700 mt-2">We couldn't fetch the data from the server. Please try again later.</p>
                 <p id="error-message" class="text-red-600 text-sm mt-4 font-mono"></p>
            </div>
        </main>

        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Last updated: <span id="last-updated">Never</span></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const chartContainer = document.getElementById('chart-container');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            const lastUpdatedSpan = document.getElementById('last-updated');
            
            // Hide chart and error message initially
            chartContainer.style.display = 'none';

            
            function padChartData(dates, values) {
                const MAX_DAYS = 30;
                const paddedDates = [];
                const paddedValues = [];

                const today = new Date();
                for (let i = MAX_DAYS - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    const index = dates.indexOf(formattedDate);
                    if (index !== -1) {
                        paddedDates.push(formattedDate);
                        paddedValues.push(values[index]);
                    } else {
                        paddedDates.push(formattedDate);
                        paddedValues.push(null); // No data for this day
                    }
                }
                return { paddedDates, paddedValues };
            }

            // Apply padding to historical data
            const padded = padChartData(historicalDates, historicalValues);
            historicalDates = padded.paddedDates;
            historicalValues = padded.paddedValues;


            try {
                // This endpoint '/api/data' will be handled by your Cloudflare Worker.
                const response = await fetch('/api/data');

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with status ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                // The worker now returns historicalValues and historicalDates directly
                const values = result.historicalValues;
                const labels = result.historicalDates;
                const timestamp = result.timestamp;

                // --- Chart Rendering ---
                renderChart(labels, values);
                
                // --- UI Updates ---
                loadingState.style.display = 'none';
                chartContainer.style.display = 'block';
                lastUpdatedSpan.textContent = new Date(timestamp).toLocaleString();

            } catch (error) {
                console.error('Failed to fetch or render chart:', error);
                loadingState.style.display = 'none';
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message;
            }
        });

        function renderChart(labels, values) {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            // Destroy existing chart instance if it exists to prevent memory leaks
            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, { // Store chart instance globally for destruction
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Daily Value',
                            data: values,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4, // This makes the line smooth
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointRadius: 4,
                            pointHoverRadius: 7,
                        },
                        {
                            label: 'Trendline',
                            type: 'line',
                            data: values, // The plugin calculates the trend from this data
                            borderColor: 'rgb(234, 88, 12)',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5], // Dashed line for the trend
                            pointRadius: 0, // No points on the trendline
                            trendlineLinear: {
                                style: "rgb(234, 88, 12)",
                                lineStyle: "dotted",
                                width: 2
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: false, // Allows the y-axis to adapt to the data range
                            grid: {
                                color: '#e5e7eb' // Lighter grid lines
                            }
                        },
                        x: {
                            grid: {
                                display: false // Hide vertical grid lines
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1f2937',
                            titleFont: { weight: 'bold' },
                            bodySpacing: 4,
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    // Custom tooltip for the main data line
                                    if (context.datasetIndex === 0) {
                                        return ` Value: ${context.parsed.y}`;
                                    }
                                    return null; // Hide tooltip for the trendline
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
    </script>
</body>
</html>
